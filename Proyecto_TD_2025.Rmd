---
title: "Proyecto Tickets TD"
author: "José Ignacio Calatayud Cuenca"
date: "2025-03-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Algoritmo del proyecto. 

```{r}

#Cargamos las librerías
library(pdftools)
library(stringr)
library(dplyr)

```

```{r}
  
# Creamos una función para procesar el contenido del PDF y extraiga la información
procesar_ticket <- function(fichero) {
  # Leemos el contenido del PDF
  texto <- pdf_text(fichero)
  # Damos al texto un formato adecuado
  lineas <- strsplit(texto, "\n")[[1]]
  # Inicializamos las variables para almacenar la información.
  ubicacion <- NA
  codigo_postal <- NA
  localidad <- NA
  telefono_tienda <- NA
  fecha <- NA
  hora <- NA
  op <- NA
  factura_simplificada <- NA
  descripcion <- c()
  precio_unitario <- c()
  importe <- c()
  importe_total <- NA
  N.C <- NA
  AID <- NA
  AUT <- NA
  ARC <- NA
  productos <- data.frame(Descripcion = character(), P.Unit = character(), Importe = character(), Peso = character())
  # Definimos las variables booleanas.
  ticket_valido <- F
  en_productos <- F
  # Definimos el contador que vamos a emplear para ir leyendo el ticket.
  contador_lineas <- 0
  
  for (linea in lineas) {
    # Para cada iteración del bucle le añadimos uno al contador de líneas.
    contador_lineas <- contador_lineas + 1
    #Quitamos los espacios en blanco a las líneas.
    linea <- str_trim(linea)
    
    # Comprobamos si en la primera línea aparece Mercadona.
    if (str_detect(linea, "MERCADONA, S.A.")) {
      ticket_valido <- TRUE
    }
    
    #Nos aseguramos si el ticket es válido para continuar con el progreso.
    if (ticket_valido) {
      # En la segunda linea siempre se encontrará la ubicación.
      if (contador_lineas == 2) {
        ubicacion <- linea
      }
      
      # En la tercera línea se halla el código postal y la localidad, las guardamos separando la linea por el espacio.
      if (contador_lineas == 3) {
        partes <- strsplit(linea, " ")[[1]]
        codigo_postal <- partes[1]
        localidad <- partes[2]
      }
      
      #Extraemos de la cuarta línea el teléfono de la tienda, separando por los dos punto para así quedarnos únicamente con el número.
      if (contador_lineas == 4) {
        partes <- strsplit(linea, ":")[[1]]
        telefono_tienda <- partes[1]
      }
      
      #Extraemos de la quinta línea la fecha, la hora y el número del OP, separando la línea por el espacio.
      if (contador_lineas == 5) {
        partes <- strsplit(linea, " ")[[1]]
        fecha <- partes[1]
        hora <- partes[2]
        op <- partes[4]
      }
      
      #Extraemos el número de la factura simplificada de la quinta línea mediante la división de la misma por los dos puntos.
      if (contador_lineas == 5) {
        partes <- strsplit(linea, ":")[[1]]
        factura_simplificada <- partes[2]
      }
      
      #Extraemos la información que se encuentra en productos.
      if (str_detect(linea, "Descripción\\s+P\\. Unit\\s+Importe")) {
        en_productos <- TRUE
        #Empleamos la variable descripcion_temporal para poder procesar aquellos productos que están formado por dos líneas.
        descripcion_temporal <- ""
      } else if (en_productos && !str_detect(linea, "TOTAL \\(€\\)")) {
        
        # Hacemos un condicional para extraer los productos normales (ej: "1 GARROFON 1,20").
        #Si se detecta "^\\d+", que significa que comienza con uno o más dígitos, en nuestro caso es la cantidad. Luego "\\s+", que significa que va seguido de uno o más espacios. Seguido de "\\D+", que significa uno o más caracteres que no son dígitos, que en nuestro caso es la descripción del producto. A continuación otro "\\s+" y por último "\\d+,\\d{2}$", que significa que es uno o más dígitos (precio en euros), seguido de una coma y exactamente 2 dígitos (los céntimos).
        if (str_detect(linea, "^\\d+\\s+\\D+\\s+\\d+,\\d{2}$")) {
          
          # Dividimos la linea en partes después de "\\s+", que significa uno o más espacios y "(?=\\d+,\\d{2}$)", que busca el precio (explicado anteriormente) sin incluirlo en la separación. Utilizamos simplify con un valor TRUE para que así nos devuelva partes como una matriz que es de más fácil acceso. 
          partes <- str_split(linea, "\\s+(?=\\d+,\\d{2}$)", simplify = TRUE)
          productos <- rbind(productos, data.frame(
            Descripcion <- partes[1,1],
            P.Unit <- NA,
            Importe <- partes[1,2],
          ))
        }
        
        #Productos que comienzan con letras (por ejemplo, "CIGALA PEQUEÑA REF") y que NO sean "PESCADO". Se guarda la descripción en descripcion_temporal y se pasa a la siguiente línea.
        else if (str_detect(linea, "^[A-Za-z]") && toupper(str_trim(linea)) != "PESCADO") {
    descripcion_temporal <- str_trim(linea)
    next
  }
         #Cuando ya se tiene una descripcion_temporal y la línea contiene datos de peso (ej: "0,222 kg 16,85 €/kg 3,74").
        else if (nchar(descripcion_temporal) > 0 && str_detect(linea, "kg.*\\d+,\\d{2}$")) {
    precio_total <- str_extract(linea, "\\d+,\\d{2}$")
    productos <- rbind(productos, data.frame(
      Descripcion = descripcion_temporal,
      P.Unit = str_extract(linea, "\\d+,\\d{2}\\s*€/kg"),
      Importe = precio_total,
      Peso = str_extract(linea, "\\d+,\\d+\\s*kg"),
    ))
    # Reiniciamos la variable temporal.
    descripcion_temporal <- ""
  }
        # Productos que contienen peso (ej: "0,840 kg 1,85 €/kg 1,55").
        else if (str_detect(linea, "kg.*\\d+,\\d{2}$")) {
          precio_total <- str_extract(linea, "\\d+,\\d{2}$")
          productos <- rbind(productos, data.frame(
            Descripcion = lineas[contador_lineas-1] %>% str_trim(),
            P.Unit = str_extract(linea, "\\d+,\\d{2}\\s*€/kg"),
            Importe = precio_total,
          ))
        }
    
        # Cuando lleguemos a la parte del TOTAL, finalizará el proceso de extracción de elementos de la descripción asignándole el valor FALSE a la variable en_productos.
      } else if (str_detect(linea, "TOTAL \\(€\\)")) {
  en_productos <- FALSE
  en_total <- TRUE
      }
        # Procesamos la información que se encuentra tras el total, pasando la descripción.
        if (en_productos != TRUE & en_total == TRUE){
         # Continuamos recorriendo las líneas restantes
          for (i in (contador_lineas + 1):length(lineas)) {
  linea <- str_trim(lineas[i]) 
          }
          # Extraemos el precio total de la línea.
          if (grepl("^TOTAL \\(€\\)", linea)) {
            # Extrae el importe total usando la función sub para extraer los valores numéricos en este caso el precio del final de la línea.
            # El .* significa cualquier carácter cero o más veces hasta (\\d+,\\d{2}) que indica un número con formato dígitos, una coma y dos decimales finalizando con el $ para asegurarse que es el final de la cadena. Y el \\1 nos asegura que la función extraerá el primer grupo capturado.
            importe_total <- sub(".* (\\d+,\\d{2})$", "\\1", linea)
          }
          # Extraemos los datos del IVA, la base imponible y la cuota, detectando una línea que comienza con un porcentaje, por ejemplo: "0% 21,06 0,00".
           if (grepl("^\\d+%", linea)) {
             partes <- strsplit(linea, "\\s+")[[1]]
             # Combinamos los vectores, asignándoles las partes correspondientes.
             iva <- c(iva, partes[1])
             base_imponible <- c(base_imponible, partes[2])
             cuota <- c(cuota, partes[3])
           }
            # Extraemos el N.C y AUT.
            if (grepl("^N\\.C:", linea)) {
              # Sabemos que la línea tiene la forma: "N.C: 098100761  AUT: 123754".
              partes <- strsplit(linea, "\\s+")[[1]]
              N.C <- partes[2]
              AUT <- partes[4] 
            }
            # Extraemos el AID y ARC.
            if (grepl("^AID:", linea)) { 
              # Sabemos que la línea tiene la forma: "AID: A0000000041010   ARC: 3030".
              partes <- strsplit(linea, "\\s+")[[1]]
              AID <- partes[2]
              ARC <- partes[4]
            }
  }
            
  }
  }

}

```


```{r}

# Obtenemos la lista de archivos PDF en el directorio datay nos aseguramos que también detecte los archivos ".PDF" mediante "ignore.case = TRUE".
  archivos_pdf <- list.files("./data", pattern = "\\.pdf$", full.names = TRUE, ignore.case = TRUE)

# Verificamos que se encuentren archivos pdf.
if (length(archivos_pdf) == 0) {
  stop("No se encontraron archivos PDF en el directorio ./data")
}

  print("Archivos PDF detectados:")
  print(archivos_pdf)  # Verifica que se detecten los archivos PDF

# Llamamos a la función con estos archivos
  for (pdf in archivos_pdf) {
    # Procesar el ticket
    informacion_ticket <- procesar_ticket(pdf)
  }
  
```

