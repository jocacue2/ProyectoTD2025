---
title: "Proyecto Tickets TD"
author: "José Ignacio Calatayud Cuenca"
date: "2025-03-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Algoritmo del proyecto. 

```{r}

#Cargamos las librerías
library(pdftools)
library(stringr)
library(dplyr)

```

```{r}
  
# Creamos una función para procesar el contenido del PDF y extraiga la información
procesar_ticket <- function(fichero) {
  # Leemos el contenido del PDF
  texto <- pdf_text(fichero)
  # Damos al texto un formato adecuado
  lineas <- strsplit(texto, "\n")[[1]]
  # Inicializamos las variables para almacenar la información.
  ubicacion <- NA
  codigo_postal <- NA
  localidad <- NA
  telefono_tienda <- NA
  fecha <- NA
  hora <- NA
  op <- NA
  factura_simplificada <- NA
  descripcion <- c()
  precio_unitario <- c()
  importe <- c()
  importe_total <- NA
  iva <- c()
  base_imponible <- c()
  cuota <- c()
  N.C <- NA
  AID <- NA
  AUT <- NA
  ARC <- NA
  productos <- data.frame(Descripcion = character(), P.Unit = character(), Importe = character())
  # Definimos las variables booleanas.
  ticket_valido <- F
  en_productos <- F
  # Definimos el contador que vamos a emplear para ir leyendo el ticket.
  contador_lineas <- 0
  
  for (linea in lineas) {
    # Para cada iteración del bucle le añadimos uno al contador de líneas.
    contador_lineas <- contador_lineas + 1
    #Quitamos los espacios en blanco a las líneas.
    linea <- str_trim(linea)
    
    # Comprobamos si en la primera línea aparece Mercadona.
    if (str_detect(linea, "MERCADONA, S.A.")) {
      ticket_valido <- TRUE
    }
    
    #Nos aseguramos si el ticket es válido para continuar con el progreso.
    if (ticket_valido) {
      # En la segunda linea siempre se encontrará la ubicación.
      if (contador_lineas == 2) {
        ubicacion <- linea
      }
      
      # En la tercera línea se halla el código postal y la localidad, las guardamos separando la linea por el espacio.
      if (contador_lineas == 3) {
        partes <- strsplit(linea, " ")[[1]]
        codigo_postal <- partes[1]
        localidad <- partes[2]
      }
      
      #Extraemos de la cuarta línea el teléfono de la tienda, separando por los dos punto para así quedarnos únicamente con el número.
      if (contador_lineas == 4) {
        partes <- strsplit(linea, ":")[[1]]
        telefono_tienda <- partes[1]
      }
      
      #Extraemos de la quinta línea la fecha, la hora y el número del OP, separando la línea por el espacio.
      if (contador_lineas == 5) {
        partes <- strsplit(linea, " ")[[1]]
        fecha <- partes[1]
        hora <- partes[2]
        op <- partes[4]
      }
      
      #Extraemos el número de la factura simplificada de la quinta línea mediante la división de la misma por los dos puntos.
      if (contador_lineas == 5) {
        partes <- strsplit(linea, ":")[[1]]
        factura_simplificada <- partes[2]
      }
      
      #Extraemos la información que se encuentra en productos.
      if (str_detect(linea, "Descripción\\s+P\\. Unit\\s+Importe")) {
        en_productos <- TRUE
      } else if (en_productos && !str_detect(linea, "TOTAL \\(€\\)")) {
        
        # Hacemos un condicional para extraer los productos normales (ej: "1 GARROFON 1,20").
        #Si se detecta "^\\d+", que significa que comienza con uno o más dígitos, en nuestro caso es la cantidad. Luego "\\s+", que significa que va seguido de uno o más espacios. Seguido de "\\D+", que significa uno o más caracteres que no son dígitos, que en nuestro caso es la descripción del producto. A continuación otro "\\s+" y por último "\\d+,\\d{2}$", que significa que es uno o más dígitos (precio en euros), seguido de una coma y exactamente 2 dígitos (los céntimos).
        if (str_detect(linea, "^\\d+\\s+\\D+\\s+\\d+,\\d{2}$")) {
          
          # Dividimos la linea en partes después de "\\s+", que significa uno o más espacios y "(?=\\d+,\\d{2}$)", que busca el precio (explicado anteriormente) sin incluirlo en la separación. Utilizamos simplify con un valor TRUE para que así nos devuelva partes como una matriz que es de más fácil acceso. 
          partes <- str_split(linea, "\\s+(?=\\d+,\\d{2}$)", simplify = TRUE)
          productos <- rbind(productos, data.frame(
            Descripcion = partes[1,1],
            P.Unit = NA,
            Importe = partes[1,2],
          ))
        }
        
        
          
          
        
      } else if (str_detect(linea, "TOTAL \\(€\\)")) {
  en_productos <- FALSE
    }
  }
}

```